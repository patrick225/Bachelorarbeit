package logic;
import java.io.File;
import java.io.FileInputStream;
import java.io.FileNotFoundException;
import java.io.IOException;

import org.json.simple.JSONObject;

import connection.OnControllerMessageReceived;
import connection.OnRobotMessageReceived;
import connection.UDPConnectionHandler;
import connection.WebsocketSocket;
import message.ControllerStatus;
import message.RobotStatus;


public class Player {

	
	private WebsocketSocket controller;
	
	private UDPConnectionHandler robot;
	
	private int score = 0;
	
	private CommandTask commandTaskToRobot;
	private CommandTask commandTaskToController;
	
	private byte[] pictureData = new byte[67425];
	
	
	
	public void setDevices(UDPConnectionHandler robot, WebsocketSocket controller) {
		this.controller = controller;
		this.robot = robot;
		
		commandTaskToRobot = new CommandTask(robot);
		commandTaskToController = new CommandTask(controller, 500);
		
		commandTaskToRobot.start();
		commandTaskToController.start();
		
		controller.registerMessageListener(messageListenerController);						
		robot.registerMessageListener(messageListenerRobot);
		
		
		
		try {
			FileInputStream fis = new FileInputStream(new File("/home/patrick/Pictures/testbild.jpg"));
			fis.read(pictureData);
			
			controller.send(pictureData);
			
		} catch (FileNotFoundException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
	}
	
	
	public void unsetDevices() {
		
		controller.unregisterMessageListener();
		robot.unregisterMessageListener();
		
		controller = null;
		robot = null;
		
		commandTaskToRobot.cancel();
		commandTaskToController.cancel();
	}

	
	public void goalDetected() {
		score++;
	}
	
	
	public void setScore(int score) {
		this.score = score;
	}
	
	
	public int getScore() {
		return score;
	}
	
	
	OnControllerMessageReceived messageListenerController = new OnControllerMessageReceived() {
		
		@Override
		public void messageReceived(WebsocketSocket controller, JSONObject command) {

			commandTaskToRobot.setCommand(CommandTranslater.translateCommand(command));
		}
	};
	
	
	OnRobotMessageReceived messageListenerRobot = new OnRobotMessageReceived() {
		
		@Override
		public void messageReceived(UDPConnectionHandler robot, byte[] data) {
			
			String score = Game.getScore();
			String[] scores = score.split(":");
			
			RobotStatus rs = new RobotStatus(data);
			ControllerStatus cs = new ControllerStatus();
			cs.setAkku(rs.getAkku());
			cs.setCountP1(Integer.valueOf(scores[0]));
			cs.setCountP2(Integer.valueOf(scores[1]));
			commandTaskToController.setCommand(cs);
		
		}
	};
}
